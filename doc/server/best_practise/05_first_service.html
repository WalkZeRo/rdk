<!DOCTYPE html>
<html>
<head>
<title>05_first_service</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
</head>
<body>
<h2>目标与收获</h2>
<p>本小节将为 <code>my_first_app</code> 添加地市条件的查询服务。通过本小节的学习，你将了解到</p>
<ul>
<li>如何定制一个rest服务</li>
<li>如何查阅rest服务开发API函数手册</li>
<li>如何在页面中使用数据源调用rest服务，这是RDK一个重要工具</li>
<li>如何查询数据的手册</li>
</ul>
<h2>修改</h2>
<p>地市的数据必须从后端查询得到，而不是写死在前端，本小节就来解决这个问题。</p>
<h3>添加查询地市的rest服务</h3>
<p>RDK的rest服务也是通过编写js代码实现，拷贝这个文件 <code>app/my_first_app/server/my_service.js</code>，命名副本文件名为citys.js</p>
<p>编辑 <code>app/my_first_app/server/citys.js</code> 文件：</p>
<pre><code>(function() {

    return function(request, script) {
        //引入假数据，实际开发不可以引入
        require('$svr/mock_api.js');
        
        log('querying citys!');
        var m = matrix('select cityid, cityname from dim_comm_city');
        log('city result', m);
        return m;
    }

})();
</code></pre>

<p>这样我们实现了我们的第一个rest服务，一个查询地市的rest服务。</p>
<blockquote>
<p>注意：<br>
为了绕开数据库，我们引入了mock_api.js文件来制造假数据，各位不需要关心这个文件的实现原理。<a href="mock_api.js">单击这里</a>下载mock_api.js文件到server目录下。</p>
<p><strong>但是记住实际开发不可以引入它</strong>！</p>
</blockquote>
<p>打开浏览器，输入下面url可以调试它：</p>
<pre><code>http://localhost:8080/rdk/service/app/my_first_app/server/citys
</code></pre>

<p>一切正常的话，浏览器会打印出下面的内容</p>
<pre><code>{&quot;result&quot;:&quot;{\&quot;header\&quot;:[\&quot;cityid\&quot;,\&quot;cityname\&quot;],\&quot;field\&quot;:[\&quot;cityid\&quot;,\&quot;cityname\&quot;],\&quot;data\&quot;:[[1,\&quot;南京\&quot;],[2,\&quot;扬州\&quot;],[3,\&quot;苏州\&quot;],[4,\&quot;镇江\&quot;]]}&quot;}
</code></pre>

<p>格式很不友好，但是没关系，这些是原始数据，RDK会把他们转成一个优雅的json对象的。</p>
<p>注意到citys服务打印了一写日志 <code>log('querying citys!');</code> 这些日志写在了这个文件里了：<code>app/my_first_app/server/logs/log.txt</code></p>
<p><a name="log"></a></p>
<pre><code>2016-06-11 21:47:57,601 INFO [RunTimeHelper@my_first_app] - loading script: app/my_first_app/server/citys.js
2016-06-11 21:47:57,601 INFO [runtime_helper.js:195@citys.js] - loading script in js: app/my_first_app/server/mock_api.js 
2016-06-11 21:47:57,616 DEBUG [citys.js:7] - querying citys! 
2016-06-11 21:47:57,616 DEBUG [citys.js:9] - city result: {
  &quot;header&quot;: [&quot;cityid&quot;, &quot;cityname&quot;],
  &quot;field&quot;: [&quot;cityid&quot;, &quot;cityname&quot;],
  &quot;data&quot;: [
    [1,&quot;南京&quot;],
    [2,&quot;扬州&quot;],
    [3,&quot;苏州&quot;],
    [4,&quot;镇江&quot;]
  ]
}  
</code></pre>

<p>最后一行就是我们调用<code>log()</code>打印的日志。日志是调试服务的一个重要的手段，所以一定要熟练使用，<a href="/doc/server/service_api.html#日志">这里详细描述了rdk提供的所有日志api</a>。</p>
<blockquote>
<p>提示</p>
<ul>
<li><code>log()</code>函数可以接收任意数量的参数</li>
<li><code>log()</code>函数可以接收任意类型的参数，它会尝试将其转为字符串。</li>
</ul>
</blockquote>
<h3>查阅API函数手册</h3>
<p>在实现citys服务的时候，我们用到了两个API函数，分别是<a href="/doc/server/service_api.html#日志"><code>log()</code></a>和<a href="/doc/server/service_api.html#matrix()"><code>matrix()</code></a>，<a href="/doc/server/service_api.html">这个页面</a>提供了所有RDK的所有API函数的说明。为了更好的使用它们，建议仔细阅读。</p>
<h3>调用citys服务</h3>
<p>citys服务是一个标准的restful服务，它可以被任意ajax请求调用。</p>
<p>下面我们来看看如何利用RDK的数据源组件调用它。编辑 <code>app/my_first_app/web/index.html</code>，修改后的rdk_basic_selector节点代码如下：</p>
<pre><code>&lt;rdk_basic_selector ds=&quot;dsCitys&quot; ds_url=&quot;$svr/citys&quot; ds_query_if=&quot;ready&quot;
    multiple_select=&quot;true&quot; label_field=&quot;name&quot; track_item_by=&quot;id&quot; editable=&quot;false&quot;&gt;
&lt;/rdk_basic_selector&gt;
</code></pre>

<p>主要是在rdk_basic_selector上添加了3个属性：<code>ds=&quot;dsCitys&quot; ds_url=&quot;$svr/citys&quot; ds_query_if=&quot;ready&quot;</code>。这3个属性的作用是创建一个名为<code>dsCitys</code>的数据源，它指向的url是<code>$svr/citys</code>，并且在页面一准备好后立即发起查询，查询得到的数据直接提供给rdk_basic_selector。</p>
<p>但是这还不能让页面正常工作。</p>
<blockquote>
<p>实践：<br>
此时刷新页面，看到的应该和下图差不多：</p>
<p><img src="img/invalid_city.PNG" /></p>
</blockquote>
<p>原因很简单，我们在<a href="04_finish_condition_bar.html#city-mock-data">上一步</a>提供给<a href="/doc/client/controls/basicselector/index.html"><code>BasicSelector</code></a>的数据结构和<a href="#log">本文前面</a>日志中输出的数据结构不一致导致了这个问题。</p>
<p>那么如何解决它呢？我们需要对rest服务查询得到的数据做转换。</p>
<p>在rdk_basic_selector节点添加另一个属性 <code>ds_data_processor=&quot;cityProcessor&quot;</code>，它的作用是对服务端返回的数据做转换。它的值是scope上的一个函数。编辑main.js，在scope上添加一个名为cityProcessor的函数：</p>
<pre><code>scope.cityProcessor = function(rawCitys) {
    var citys = [];
    angular.forEach(rawCitys.data, function(item) {
        citys.push({id: item[0], name: item[1]});
    });
    //必须把转换后的数据返回
    return citys;
}
</code></pre>

<blockquote>
<p>实践：<br>
实际上，我们大可不必把转换的逻辑放在前端，我们在实现citys服务的时候，就可以在后端完成这个转换的逻辑，你可以改写citys服务，以避免在前端做数据转换。</p>
</blockquote>
<p>到此，我们刷新页面后，就能看到和之前相同的效果了，唯一的差别是我们的地市数据是从rest访问查询而来的。</p>
<h3>数据源手册</h3>
<p>通过前一小节的实践，你已经学会了数据源的常规使用方法了，基本上能够满足大多数开发的需要了。<a href="/doc/client/common/datasource/">访问这里</a>可以查阅数据源的其他用法，以及每个属性的详细说明。</p>
<h3>删除不用的文件和代码</h3>
<ul>
<li>删除 main.js 中，<code>scope.citys</code> 变量</li>
<li>删除 server/my_service.js 文件</li>
<li>删除 server/mylib.js 文件</li>
</ul>
<h3>关于 $svr 宏</h3>
<p>本文前面多次使用到 <code>$svr</code> 这个宏，<a href="/doc/server/relative_path_rule.html">这里</a>有关于它的使用说明。</p>
<h2>小结</h2>
<p>我们实现了第一个RDK服务citys，并成功利用<a href="/doc/client/common/datasource">数据源</a>调用这个服务，同时对数据做了一些转换。</p>
<p>你可以下载完成此步骤之后的<a href="05_first_service.zip">源码</a>，解压到 <code>app/my_first_app</code> 下，<a href="/rdk/app/my_first_app/web/index.html">单击这里</a>就可以打开它了。</p>
<div title="第5步 实现第一个RDK服务并调用它 - RDK应用开发最佳实践" id="__hidden__">
<script src="/doc/tools/doc_js/misc.js"></script>
</div>
</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
